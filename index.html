<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¨¡æ“¬è‚¡ç¥¨äº¤æ˜“ç«¶è³½ï¼ˆå«æå‰çµæŸï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden { display: none; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    button:disabled { cursor: not-allowed; opacity: .6; }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="screen-setup" class="min-h-screen p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-8">
      <h1 class="text-3xl font-bold text-indigo-600 mb-6 text-center">ğŸ“Š æ¨¡æ“¬è‚¡ç¥¨äº¤æ˜“ç«¶è³½</h1>

      <div class="space-y-6">
        <div>
          <label class="block text-lg font-semibold text-gray-700 mb-3">â± æ¯”è³½æ™‚é–“</label>
          <div class="grid grid-cols-4 gap-3">
            <button data-time="120" class="time-btn py-3 rounded-lg font-semibold bg-indigo-600 text-white">2 åˆ†é˜</button>
            <button data-time="180" class="time-btn py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200">3 åˆ†é˜</button>
            <button data-time="300" class="time-btn py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200">5 åˆ†é˜</button>
            <button data-time="480" class="time-btn py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200">8 åˆ†é˜</button>
          </div>
        </div>

        <div>
          <label class="block text-lg font-semibold text-gray-700 mb-3">ğŸ’µ åŸå§‹è³‡é‡‘</label>
          <div class="flex gap-4">
            <button data-cash="100000" class="cash-btn flex-1 py-3 rounded-lg font-semibold bg-indigo-600 text-white">10 è¬</button><button data-cash="200000" class="cash-btn flex-1 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200">20 è¬</button><button data-cash="300000" class="cash-btn flex-1 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200">30 è¬</button><button data-cash="500000" class="cash-btn flex-1 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200">50 è¬</button></div>
        </div>

        <div>
          <label class="block text-lg font-semibold text-gray-700 mb-3">ğŸ‘¤ ä½¿ç”¨è€…åç¨±</label>
          <input id="input-username" type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„ä»£è™Ÿ" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" />
        </div>

        
<button id="btn-help" class="w-full py-3 bg-yellow-100 text-yellow-800 rounded-lg font-semibold hover:bg-yellow-200 transition">â“ éŠæˆ²èªªæ˜</button>
<div id="help-panel" class="bg-blue-50 p-4 rounded-lg text-sm text-gray-700 space-y-2 hidden">
  <p><strong>ğŸ“Œ éŠæˆ²è¦å‰‡ï¼š</strong></p>
  <ul class="list-disc list-inside space-y-1">
    <li>åœ¨é™å®šæ™‚é–“å…§é€éè²·è³£è‚¡ç¥¨è³ºå–æœ€é«˜ç²åˆ©ã€‚</li>
    <li>æ”¯æ´é›¶è‚¡äº¤æ˜“ï¼šå¯è²·è³£ 10ã€50ã€100ã€200ã€500ã€1000 è‚¡ã€‚</li>
    <li>è‚¡åƒ¹æ¯ 2 ç§’æ›´æ–°ä¸€æ¬¡ï¼Œæ³¢å‹•ç¯„åœç´„ Â±0.5%ã€‚</li>
    <li>è²·é€²æ‰‹çºŒè²»ï¼š0.1%ï¼Œè³£å‡ºæ‰‹çºŒè²»ï¼š0.4%ã€‚</li>
    <li>âš ï¸ æ™‚é–“çµæŸæˆ–æå‰çµæŸæ™‚ï¼Œè‡ªå‹•ä»¥å¸‚åƒ¹è³£å‡ºæ‰€æœ‰æŒè‚¡ã€‚</li>
    <li>æœ€çµ‚ç¸½è³‡ç”¢ = çµç®—å¾Œç¾é‡‘ç¸½é¡ã€‚</li>
  </ul>
</div>

        <button id="btn-start" class="w-full py-4 bg-green-600 text-white rounded-lg font-bold text-xl hover:bg-green-700">â–¶ï¸ é–‹å§‹æ¯”è³½</button>
      </div>
    </div>
  </div>

  <div id="screen-playing" class="hidden min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center justify-between gap-2 mb-4">
        <div class="flex-1 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg p-6 text-center shadow-lg">
          <span class="text-5xl font-bold" id="timer">0:00</span>
        </div>
        <button id="btn-end-early" class="whitespace-nowrap px-4 py-3 bg-gray-800 text-white rounded-lg font-semibold hover:bg-black shadow-lg">
          â¹ æå‰çµæŸ
        </button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="space-y-4">
          <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ˆ è‚¡ç¥¨æ¸…å–®</h2>
            <div id="stock-list" class="space-y-2"></div>
          </div>

          <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“¦ æŒè‚¡ç‹€æ³</h2>
            <div id="portfolio-cards" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
          </div>

          <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ äº¤æ˜“ç´€éŒ„</h2>
            <div id="tx-list" class="space-y-2"></div>
          </div>
        </div>

        <div class="space-y-4">
          <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between mb-2">
              <h2 class="text-xl font-bold text-gray-800">ğŸ’° å¸³æˆ¶è³‡è¨Š</h2>
              <span id="ui-username-badge" class="text-sm px-2 py-1 bg-indigo-100 text-indigo-700 rounded hidden"></span>
            </div>
            <div class="space-y-3">
              <div class="p-3 bg-indigo-50 rounded-lg">
                <div class="text-sm text-gray-600">ç¸½è³‡ç”¢</div>
                <div id="ui-total-assets" class="text-3xl font-bold text-indigo-600">$0</div>
                <div id="ui-profit" class="text-sm">0 (0%)</div>
              </div>
              <div class="flex justify-between"><span class="text-gray-600">å¯ç”¨ç¾é‡‘</span><span id="ui-cash" class="font-semibold">$0</span></div>
              <div class="flex justify-between"><span class="text-gray-600">ç¸½äº¤æ˜“æˆæœ¬</span><span id="ui-fee" class="font-semibold text-red-600">$0</span></div>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold text-gray-800">ğŸ¯ äº¤æ˜“ä¸‹å–®</h2>
              <div class="text-sm text-gray-600">ä½¿ç”¨è€…ï¼š<span id="ui-username" class="font-semibold">â€”</span></div>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">é¸æ“‡è‚¡ç¥¨</label>
                <div id="ui-selected-stock" class="p-3 bg-gray-100 rounded-lg text-center text-gray-500">è«‹é»æ“Šå·¦å´è‚¡ç¥¨é¸æ“‡</div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">è‚¡æ•¸ï¼ˆé›¶è‚¡äº¤æ˜“ï¼‰</label>
                <select id="input-qty" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                  <option value="10">10 è‚¡</option>
                  <option value="50">50 è‚¡</option>
                  <option value="100">100 è‚¡</option>
                  <option value="200">200 è‚¡</option>
                  <option value="500">500 è‚¡</option>
                  <option value="1000">1000 è‚¡ï¼ˆ1 å¼µï¼‰</option>
                </select>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button id="btn-buy" class="py-3 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600" disabled>è²·é€²</button>
                <button id="btn-sell" class="py-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600" disabled>è³£å‡º</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/40">
      <div class="w-[92%] max-w-md bg-white rounded-xl shadow-2xl p-6">
        <div class="flex items-center gap-2 text-red-600 mb-3">
          <span>âš ï¸</span>
          <h3 class="text-xl font-bold">ç¾é‡‘ä¸è¶³ï¼</h3>
        </div>
        <div class="space-y-2 text-gray-800">
          <div class="flex justify-between"><span>æ­¤ç­†ä¸‹å–®éœ€è¦ï¼š</span><span id="need" class="font-semibold">$0</span></div>
          <div class="flex justify-between"><span>ç›®å‰ç¾é‡‘ï¼š</span><span id="have" class="font-semibold">$0</span></div>
          <div class="flex justify-between"><span>é‚„å·®ï¼š</span><span id="gap" class="font-semibold text-red-600">$0</span></div>
        </div>
        <div class="mt-6 grid grid-cols-2 gap-2">
          <button id="btn-close-modal" class="py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold">é—œé–‰</button>
          <button id="btn-buy-10" class="py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">æ”¹è²· 10 è‚¡</button>
        </div>
      </div>
    </div>
  </div>

  <div id="screen-finished" class="hidden min-h-screen p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ‰ æ¯”è³½çµæŸï¼</h1>
        <p id="final-username" class="text-gray-600"></p>
      </div>
      <div id="final-summary" class="p-6 rounded-xl mb-6"></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-blue-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600 mb-1">åŸå§‹è³‡é‡‘</div>
          <div id="final-initial" class="text-2xl font-bold text-blue-600">$0</div>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600 mb-1">æœ€çµ‚ç¸½è³‡ç”¢</div>
          <div id="final-assets" class="text-2xl font-bold text-purple-600">$0</div>
        </div>
        <div class="bg-red-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600 mb-1">ç¸½äº¤æ˜“æˆæœ¬</div>
          <div id="final-fee" class="text-2xl font-bold text-red-600">$0</div>
        </div>
      </div>
      <div class="bg-gray-50 p-6 rounded-lg mb-6 text-center text-lg">
        <span class="text-gray-700">æœ€çµ‚ç¾é‡‘ï¼š</span>
        <span id="final-cash" class="font-bold text-indigo-600 text-2xl ml-2">$0</span>
      </div>
      <button id="btn-restart" class="w-full py-4 bg-indigo-600 text-white rounded-lg font-bold text-xl hover:bg-indigo-700">å†ç©ä¸€æ¬¡</button>
    </div>
  </div>

  <script>
  window.addEventListener('load', function() {
    var gameState = 'setup';
    var timeLeft = 120;
    var selectedTime = 120;
    var initialCash = 100000;
    var userName = '';
    var cash = initialCash;
    var totalFee = 0;
    var portfolio = {};
    var transactions = [];
    var stocks = [
      { code: '2330', name: 'å°ç©é›»', price: 580, change: 0 },
      { code: '0050', name: 'å…ƒå¤§å°ç£50', price: 63.5, change: 0 },
      { code: '2882', name: 'åœ‹æ³°é‡‘', price: 64.7, change: 0 }
    ];
    var selectedStock = null;
    var timerInterval = null;
    var priceInterval = null;

    function $(id){ return document.getElementById(id); }
    function fmt(n){ return '$' + Number(n).toLocaleString(); }

    function setScreen(name){
      ['screen-setup','screen-playing','screen-finished'].forEach(function(id){
        var el = $(id);
        if (!el) return;
        if (id === 'screen-' + name) el.classList.remove('hidden'); else el.classList.add('hidden');
      });
      gameState = name;
    }

    function calculateTotalAssets(){
      var stockValue = 0;
      Object.keys(portfolio).forEach(function(code){
        var s = stocks.find(function(x){ return x.code === code; });
        if (s && portfolio[code].quantity > 0){ stockValue += s.price * portfolio[code].quantity; }
      });
      return cash + stockValue;
    }

    function calculateFee(amount, isBuy){
      var rate = isBuy ? 0.001 : 0.004;
      return Math.floor(amount * rate);
    }

    function renderStockList(){
      var wrap = $('stock-list');
      wrap.innerHTML = '';
      stocks.forEach(function(stock){
        var holding = portfolio[stock.code];
        var btn = document.createElement('button');
        btn.className = "w-full p-4 rounded-lg text-left transition border " + (selectedStock === stock.code ? "bg-indigo-50 border-indigo-500" : "bg-gray-50 hover:bg-gray-100 border-transparent");
        var holdingHtml = holding ? '<div class="mt-1 text-xs text-gray-700">æŒæœ‰ï¼š<span class="font-semibold">' + holding.quantity + ' è‚¡</span>ï½œå‡åƒ¹ï¼š<span class="font-semibold">' + holding.avgCost.toFixed(2) + '</span></div>' : '';
        btn.innerHTML =
          '<div class="flex justify-between items-start">' +
            '<div>' +
              '<div class="font-bold text-lg">' + stock.name + '</div>' +
              '<div class="text-gray-600 text-sm">' + stock.code + '</div>' +
              holdingHtml +
            '</div>' +
            '<div class="text-right">' +
              '<div class="text-2xl font-bold">$' + stock.price.toFixed(2) + '</div>' +
              '<div class="flex items-center justify-end ' + (stock.change >= 0 ? 'text-green-600' : 'text-red-600') + '">' +
                '<span class="ml-1">' + (stock.change >= 0 ? '+' : '') + stock.change + '%</span>' +
              '</div>' +
            '</div>' +
          '</div>';
        btn.addEventListener('click', function(){ selectedStock = stock.code; renderSelection(); renderStockList(); });
        wrap.appendChild(btn);
      });
    }

    function renderSelection(){
      var label = $('ui-selected-stock');
      var btnBuy = $('btn-buy');
      var btnSell = $('btn-sell');
      if (selectedStock){
        var s = stocks.find(function(x){ return x.code === selectedStock; });
        label.textContent = s.name + ' (' + s.code + ')';
        label.classList.remove('text-gray-500');
        btnBuy.disabled = false; btnSell.disabled = false;
      } else {
        label.textContent = 'è«‹é»æ“Šå·¦å´è‚¡ç¥¨é¸æ“‡';
        label.classList.add('text-gray-500');
        btnBuy.disabled = true; btnSell.disabled = true;
      }
    }

    function renderPortfolio(){
      var box = $('portfolio-cards');
      box.innerHTML = '';
      var codes = Object.keys(portfolio);
      if (codes.length === 0){
        box.innerHTML = '<p class="text-gray-500 text-center py-4 w-full">ç›®å‰ç„¡æŒè‚¡</p>';
        return;
      }
      codes.forEach(function(code){
        var holding = portfolio[code];
        if (!holding || holding.quantity <= 0) return;
        var s = stocks.find(function(x){ return x.code === code; });
        var currentValue = s.price * holding.quantity;
        var cost = holding.avgCost * holding.quantity;
        var pnl = currentValue - cost;
        var card = document.createElement('div');
        card.className = 'p-4 bg-gray-50 rounded-lg';
        card.innerHTML =
          '<div class="flex justify-between mb-2"><span class="font-bold text-lg">' + s.name + '</span><span class="text-gray-600">' + code + '</span></div>' +
          '<div class="flex justify-between mb-1"><span class="text-gray-600">æŒæœ‰</span><span class="font-semibold">' + holding.quantity + ' è‚¡</span></div>' +
          '<div class="flex justify-between mb-1"><span class="text-gray-600">æˆæœ¬</span><span class="text-sm">$' + holding.avgCost.toFixed(2) + '</span></div>' +
          '<div class="flex justify-between"><span class="text-gray-600">æç›Š</span><span class="font-bold ' + (pnl >= 0 ? 'text-green-600' : 'text-red-600') + '">' + (pnl >= 0 ? '+' : '') + pnl.toLocaleString() + '</span></div>';
        box.appendChild(card);
      });
    }

    function renderTx(){
      var box = $('tx-list');
      box.innerHTML = '';
      if (transactions.length === 0){
        box.innerHTML = '<p class="text-gray-500 text-center py-4">å°šç„¡äº¤æ˜“ç´€éŒ„</p>';
        return;
      }
      transactions.slice(0, 10).forEach(function(tx){
        var row = document.createElement('div');
        row.className = 'grid grid-cols-5 items-center p-2 bg-gray-50 rounded text-sm';
        row.innerHTML =
          '<span class="text-gray-600">' + tx.time + '</span>' +
          '<span class="font-semibold ' + (tx.type === 'è²·é€²' ? 'text-green-600' : 'text-red-600') + '">' + tx.type + '</span>' +
          '<span>' + tx.code + '</span>' +
          '<span>$' + tx.price + '</span>' +
          '<span>' + tx.quantity + 'è‚¡</span>';
        box.appendChild(row);
      });
    }

    function renderAccount(){
      var totalAssets = calculateTotalAssets();
      var profit = totalAssets - initialCash;
      $('ui-total-assets').textContent = fmt(totalAssets);
      var pct = ((profit / initialCash) * 100).toFixed(2);
      var profitEl = $('ui-profit');
      profitEl.textContent = (profit >= 0 ? '+' : '') + profit.toLocaleString() + ' (' + pct + '%)';
      profitEl.className = 'text-sm ' + (profit >= 0 ? 'text-green-600' : 'text-red-600');
      $('ui-cash').textContent = fmt(cash);
      $('ui-fee').textContent = fmt(totalFee);
    }

    function updateTimerLabel(){
      var m = Math.floor(timeLeft / 60);
      var s = String(timeLeft % 60).padStart(2,'0');
      $('timer').textContent = m + ':' + s;
    }

    function startGame(){
      if (!userName || !userName.trim()){
        alert('è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±ï¼');
        return;
      }
      cash = initialCash;
      totalFee = 0;
      portfolio = {};
      transactions = [];
      selectedStock = null;
      timeLeft = selectedTime;

      setScreen('playing');
      $('ui-username-badge').textContent = userName;
      $('ui-username-badge').classList.remove('hidden');
      $('ui-username').textContent = userName;

      renderSelection();
      renderStockList();
      renderTx();
      renderAccount();
      renderPortfolio();
      updateTimerLabel();

      priceInterval = setInterval(function(){
        stocks = stocks.map(function(s){
          var changeRate = (Math.random() - 0.5) * 0.01; // Â±0.5%
          var newPrice = Math.round(s.price * (1 + changeRate) * 100) / 100;
          var changePct = ((newPrice - s.price) / s.price * 100);
          return { code:s.code, name:s.name, price:newPrice, change: Number(changePct.toFixed(2)) };
        });
        renderStockList();
        renderPortfolio();
        renderAccount();
      }, 2000);

      timerInterval = setInterval(function(){
        timeLeft -= 1;
        updateTimerLabel();
        if (timeLeft <= 0){
          endGame();
        }
      }, 1000);
    }

    function endGame(){
      if (timerInterval) clearInterval(timerInterval);
      if (priceInterval) clearInterval(priceInterval);

      Object.keys(portfolio).forEach(function(code){
        var s = stocks.find(function(x){ return x.code === code; });
        var holding = portfolio[code];
        if (s && holding.quantity > 0){
          var amount = s.price * holding.quantity;
          var fee = calculateFee(amount, false);
          cash += (amount - fee);
          totalFee += fee;
          holding.quantity = 0;
        }
      });

      var finalAssets = calculateTotalAssets();
      var finalProfit = finalAssets - initialCash;
      var returnRate = ((finalProfit / initialCash) * 100).toFixed(2);

      var summary = $('final-summary');
      summary.className = 'p-6 rounded-xl mb-6 ' + (finalProfit >= 0 ? 'bg-green-50 border-2 border-green-500' : 'bg-red-50 border-2 border-red-500');
      summary.innerHTML =
        '<div class="text-center">' +
          '<div class="text-2xl font-semibold text-gray-700 mb-2">æœ€çµ‚ç²åˆ©</div>' +
          '<div class="text-6xl font-bold ' + (finalProfit >= 0 ? 'text-green-600' : 'text-red-600') + '">' + (finalProfit >= 0 ? '+' : '') + finalProfit.toLocaleString() + '</div>' +
          '<div class="text-xl mt-2 ' + (finalProfit >= 0 ? 'text-green-600' : 'text-red-600') + '">å ±é…¬ç‡ï¼š' + returnRate + '%</div>' +
        '</div>';

      $('final-username').textContent = 'åƒè³½è€…ï¼š' + userName;
      $('final-initial').textContent = fmt(initialCash);
      $('final-assets').textContent = fmt(finalAssets);
      $('final-fee').textContent = fmt(totalFee);
      $('final-cash').textContent = fmt(cash);

      setScreen('finished');
    }

    function confirmEndEarly(){
      var ok = confirm('ç¢ºå®šè¦æå‰çµæŸæ¯”è³½å—ï¼Ÿ\nç³»çµ±æœƒä»¥å¸‚åƒ¹è³£å‡ºæ‰€æœ‰æŒè‚¡ä¸¦é€²è¡Œçµç®—ã€‚');
      if (ok){ endGame(); }
    }

    function buy(){
      if (!selectedStock){ alert('è«‹é¸æ“‡è‚¡ç¥¨ï¼'); return; }
      var s = stocks.find(function(x){ return x.code === selectedStock; });
      var qty = Number($('input-qty').value) || 10;
      var amount = s.price * qty;
      var fee = calculateFee(amount, true);
      var total = amount + fee;
      if (cash < total){
        $('need').textContent = fmt(total);
        $('have').textContent = fmt(cash);
        $('gap').textContent = fmt(total - cash);
        $('modal-overlay').classList.remove('hidden');
        return;
      }
      cash -= total;
      totalFee += fee;
      var current = portfolio[selectedStock] || { quantity: 0, avgCost: 0 };
      var totalQuantity = current.quantity + qty;
      var totalCost = (current.avgCost * current.quantity) + amount;
      var avgCost = totalCost / totalQuantity;
      portfolio[selectedStock] = { quantity: totalQuantity, avgCost: avgCost };

      transactions.unshift({ time: new Date().toLocaleTimeString(), type: 'è²·é€²', code: selectedStock, price: s.price, quantity: qty, fee: fee });
      if (transactions.length > 50) transactions.pop();
      renderTx(); renderAccount(); renderPortfolio(); renderStockList();
    }

    function sell(){
      if (!selectedStock){ alert('è«‹é¸æ“‡è‚¡ç¥¨ï¼'); return; }
      var s = stocks.find(function(x){ return x.code === selectedStock; });
      var qty = Number($('input-qty').value) || 10;
      var holding = portfolio[selectedStock];
      if (!holding || holding.quantity < qty){ alert('æŒè‚¡æ•¸é‡ä¸è¶³ï¼'); return; }
      var amount = s.price * qty;
      var fee = calculateFee(amount, false);
      var received = amount - fee;
      cash += received;
      totalFee += fee;
      holding.quantity -= qty;
      if (holding.quantity <= 0) delete portfolio[selectedStock];

      transactions.unshift({ time: new Date().toLocaleTimeString(), type: 'è³£å‡º', code: selectedStock, price: s.price, quantity: qty, fee: fee });
      if (transactions.length > 50) transactions.pop();
      renderTx(); renderAccount(); renderPortfolio(); renderStockList();
    }

    // Bindings
    Array.prototype.forEach.call(document.querySelectorAll('.time-btn'), function(btn){
      btn.addEventListener('click', function(){
        selectedTime = Number(btn.getAttribute('data-time')) || 120;
        Array.prototype.forEach.call(document.querySelectorAll('.time-btn'), function(b){
          b.className = 'time-btn py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200';
        });
        btn.className = 'time-btn py-3 rounded-lg font-semibold bg-indigo-600 text-white';
      });
    });

    Array.prototype.forEach.call(document.querySelectorAll('.cash-btn'), function(btn){
      btn.addEventListener('click', function(){
        initialCash = Number(btn.getAttribute('data-cash')) || 100000;
        Array.prototype.forEach.call(document.querySelectorAll('.cash-btn'), function(b){
          b.className = 'cash-btn flex-1 py-3 rounded-lg font-semibold bg-gray-100 hover:bg-gray-200';
        });
        btn.className = 'cash-btn flex-1 py-3 rounded-lg font-semibold bg-indigo-600 text-white';
      });
    });

    $('btn-start').addEventListener('click', function(){
      userName = ($('input-username').value || '').trim();
      startGame();
    });

    $('input-qty').addEventListener('change', function(e){ /* keep for parity */ });

    $('btn-buy').addEventListener('click', buy);
    $('btn-sell').addEventListener('click', sell);

    $('btn-close-modal').addEventListener('click', function(){ $('modal-overlay').classList.add('hidden'); });
    $('btn-buy-10').addEventListener('click', function(){
      $('input-qty').value = '10';
      $('modal-overlay').classList.add('hidden');
    });

    $('btn-restart').addEventListener('click', function(){ setScreen('setup'); });

    $('btn-end-early').addEventListener('click', confirmEndEarly);

    $('btn-help').addEventListener('click', function(){ $('help-panel').classList.toggle('hidden'); });

    // initial paint
    setScreen('setup');
  });
  </script>
</body>
</html>
